---
description: Perform comprehensive code quality checks and prepare for commit
argument-hint: [model]
allowed-tools: Task
---

# Pre-commit Code Quality Check (Delegated)

This command delegates comprehensive pre-commit workflow to a general-purpose agent while preserving all functionality.

## Usage
- `/pre-commit` (uses default Sonnet model)
- `/pre-commit sonnet` (uses Sonnet model) 
- `/pre-commit opus` (uses Opus model)

## Task Delegation

**Arguments:** $ARGUMENTS

You are delegating a pre-commit workflow task to a general-purpose agent. Parse arguments for optional model preference (default: Sonnet).

**Instructions for Agent:**

Perform comprehensive code quality checks on changed files only, stage changes, and prepare for commit with automated commit message generation.

Follow these exact instructions:

1. **Run Code Quality Checks**
   - Execute the pre-commit checks script: `~/.claude/commands/pre-commit-checks.sh`
   - This script will:
     - Detect changed Python files (excluding deleted and autogenerated files)
     - Run ruff check/format only on changed files
     - Run type checking with pyright on changed files
     - Run deadcode detection on changed files
     - Run pytest if test files exist in the project
     - Provide a summary of results

2. **Handle Check Results**
   - Show the full output from the script
   - If the script exits with code 1 (issues found), analyze which fixes can be automated:
     - For formatting issues: offer to run `uv tool run ruff format` on changed files
     - For auto-fixable linting: offer to run `uv tool run ruff check --fix` on changed files
   - If fixes are applied, re-run the checks script to ensure everything passes

3. **Stage Changes**
   - Only if all checks pass (or user chooses to proceed despite warnings)
   - Run `git status` to see all changes
   - Add new files to VCS - only those that should be part of the project
   - Show the list of modified and new files
   - Stage all changes with `git add -u`
   - Show the final staged changes with `git diff --cached --stat`

4. **Generate Commit Message**
   - Analyze the staged changes using `git diff --cached`
   - Generate a comprehensive commit message following conventional commit format:
     - Type: feat, fix, docs, style, refactor, test, chore
     - Scope: affected area (optional)
     - Subject: concise description (50 chars or less)
     - Body: detailed explanation of what and why (wrap at 72 chars)
     - Footer: breaking changes, issues closed (if any)

5. **Request Confirmation**
   - Display the proposed commit message
   - Show a summary of staged files
   - Ask for permission to proceed with the commit
   - If approved, execute `git commit -m "message"`
   - Show the commit hash and summary

## Error Handling
- If the script fails to run, check that it exists and is executable
- If no changes are detected, inform the user there's nothing to commit
- Allow the user to skip checks if needed (with warning)

## Expected Output Format
```
üîç Running pre-commit checks on changed files...

‚ÑπÔ∏è  Detecting changed Python files...
‚ÑπÔ∏è  Found 3 changed Python files
‚ÑπÔ∏è  Running ruff check...
‚úÖ Ruff check passed
‚ÑπÔ∏è  Running ruff format check...
‚ö†Ô∏è  Code needs formatting (can be auto-fixed)
‚ÑπÔ∏è  Running type check with ty...
‚úÖ Type check passed
‚ÑπÔ∏è  Running deadcode check...
‚úÖ No dead code found
‚ÑπÔ∏è  Checking for test files...
‚ÑπÔ∏è  Running pytest...
‚úÖ All tests passed

‚ö†Ô∏è  Some checks failed or need attention

Suggested fixes:
  - Run: uv tool run ruff format . (to fix formatting)

üìù Would you like me to fix the formatting issues? (y/n)

[After fixes]
‚úÖ All checks passed! ‚ú®

üìù Staged changes:
- Modified: backend/src/api.py
- Modified: common/src/models.py
- Modified: pyproject.toml

üí¨ Proposed commit message:
fix(backend): update API error handling and type annotations

- Fix type annotations to use Python 3.12+ syntax
- Remove unused imports detected by ruff
- Update error handling to use proper exception chaining
- Format code according to project standards

üöÄ Ready to commit? (y/n)
```